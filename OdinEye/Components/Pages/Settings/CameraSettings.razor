@using OdinEye.Core.Profile
@inject IProfileProvider Profile
@inject NotificationService NotificationService

<RadzenTemplateForm TItem="CameraSettingsModel" Data="@model" Submit="OnSubmit">
    <RadzenStack>

        <RadzenFieldset>
            <HeaderTemplate>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"><strong>INDI</strong></RadzenText>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack>

                    <RadzenFormField Text="INDI Hostname" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <RadzenTextBox @bind-Value="model.IndiHostname" />
                    </RadzenFormField>

                    <RadzenFormField Text="INDI Port" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <RadzenNumeric @bind-Value="model.IndiPort" Min="1" Max="65535" />
                    </RadzenFormField>

                    <RadzenFormField Text="INDI Camera Name" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <RadzenTextBox @bind-Value="model.Name" />
                    </RadzenFormField>

                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>

        <RadzenFieldset>
            <HeaderTemplate>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"><strong>Exposure</strong></RadzenText>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack>

                    <RadzenFormField Text="Offset" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.Offset" Min="0" Max="10000" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                Camera offset value for all images.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Daytime Gain" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.DaytimeGain" Min="0" Max="10000" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                Camera gain value for daytime images.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Daytime Electron Gain [e-/ADU]" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.DaytimeElectronGain" Min="0" Max="20" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                Required for accurate auto exposure.
                                This value comes from your camera manufacturer datasheet typically as a chart where the X axis
                                is gain and the Y axis is e-/ADU. Look at the chart for your daytime gain value and input the
                                corresponding e-/ADU gain as shown on the chart.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Daytime Bias [ADU]" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.DaytimeBias" Min="0" Max="65535" Format="F0" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                The median value of a bias frame at the daytime gain setting.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Nighttime Gain" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.NighttimeGain" Min="0" Max="10000" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                Camera gain value for nighttime images.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Nighttime Electron Gain [e-/ADU]" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.NighttimeElectronGain" Min="0" Max="20" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                Required for accurate auto exposure.
                                This value comes from your camera manufacturer datasheet typically as a chart where the X axis
                                is gain and the Y axis is e-/ADU. Look at the chart for your nighttime gain value and input the
                                corresponding e-/ADU gain as shown on the chart.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                    <RadzenFormField Text="Nighttime Bias [ADU]" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <ChildContent>
                            <RadzenNumeric @bind-Value="model.NighttimeBias" Min="0" Max="65535" Format="F0" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-mt-2 rz-mb-0">
                                The median value of a bias frame at the nighttime gain setting.
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>

                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>

        <RadzenFieldset>
            <HeaderTemplate>
                <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-0"><strong>General</strong></RadzenText>
            </HeaderTemplate>
            <ChildContent>
                <RadzenStack>
                    <RadzenFormField Text="Focal Length [mm]" Variant="Variant.Outlined" AllowFloatingLabel="false">
                        <RadzenNumeric @bind-Value="model.FocalLength" Min="1" Max="10000" />
                    </RadzenFormField>
                </RadzenStack>
            </ChildContent>
        </RadzenFieldset>

        <RadzenRow>
            <RadzenButton ButtonType="ButtonType.Submit" Text="Save" />
        </RadzenRow>

    </RadzenStack>
</RadzenTemplateForm>

@code {
    private CameraSettingsModel model = new();

    protected override void OnInitialized()
    {
        model.IndiHostname = Profile.Current.Camera.IndiHostname;
        model.IndiPort = Profile.Current.Camera.IndiPort;
        model.Name = Profile.Current.Camera.Name;
        model.Offset = Profile.Current.Camera.Offset;
        model.DaytimeGain = Profile.Current.Camera.DaytimeGain;
        model.DaytimeElectronGain = Profile.Current.Camera.DaytimeElectronGain;
        model.DaytimeBias = Profile.Current.Camera.DaytimeBias;
        model.NighttimeGain = Profile.Current.Camera.NighttimeGain;
        model.NighttimeElectronGain = Profile.Current.Camera.NighttimeElectronGain;
        model.NighttimeBias = Profile.Current.Camera.NighttimeBias;
        model.FocalLength = Profile.Current.Camera.FocalLength;
    }

    private void OnSubmit(CameraSettingsModel model)
    {
        Profile.Current.Camera.IndiHostname = model.IndiHostname ?? string.Empty;
        Profile.Current.Camera.IndiPort = model.IndiPort;
        Profile.Current.Camera.Name = model.Name ?? string.Empty;
        Profile.Current.Camera.Offset = model.Offset;
        Profile.Current.Camera.DaytimeGain = model.DaytimeGain;
        Profile.Current.Camera.DaytimeElectronGain = model.DaytimeElectronGain;
        Profile.Current.Camera.DaytimeBias = model.DaytimeBias;
        Profile.Current.Camera.NighttimeGain = model.NighttimeGain;
        Profile.Current.Camera.NighttimeElectronGain = model.NighttimeElectronGain;
        Profile.Current.Camera.NighttimeBias = model.NighttimeBias;
        Profile.Current.Camera.FocalLength = model.FocalLength;

        NotificationService.Notify(new NotificationMessage
        {
            Severity = NotificationSeverity.Success,
            Duration = 2000,
            Summary = "Saved!",
        });
    }

    public record CameraSettingsModel
    {
        public string? IndiHostname { get; set; }
        public int IndiPort { get; set; }
        public string? Name { get; set; }
        public int Offset { get; set; }
        public int DaytimeGain { get; set; }
        public double DaytimeElectronGain{ get; set; }
        public double DaytimeBias{ get; set; }
        public int NighttimeGain { get; set; }
        public double NighttimeElectronGain { get; set; }
        public double NighttimeBias { get; set; }
        public double FocalLength { get; set; }
    }
}
